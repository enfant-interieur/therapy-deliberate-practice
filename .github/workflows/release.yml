name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v0.1.0). Leave empty to use the ref that started the run."
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-tauri:
    strategy:
      fail-fast: false
      matrix:
        include:
          # ---- GitHub-hosted runners (CI/CD) ----
#          - os: ubuntu-24.04
#            runs_on: ubuntu-24.04
#            bundles: "deb,appimage,rpm"
#
#          - os: windows-latest
#            runs_on: windows-latest
#            bundles: "nsis,msi"
#
#          - os: macos-latest
#            runs_on: macos-latest
#            bundles: "app,dmg"

          # ---- Your self-hosted runner (macOS ARM64) ----
          - os: macos-selfhosted
            runs_on: [ self-hosted, macOS, ARM64 ]
            bundles: "app,dmg"

    runs-on: ${{ matrix.runs_on }}
    steps:
      - uses: actions/checkout@v4
        with:
          # If manually dispatched with a tag, checkout that tag
          ref: ${{ inputs.tag || github.ref }}

      - name: Verify Tauri build script exists
        run: |
          test -f services/local-runtime-suite/desktop/src-tauri/build.rs || (echo "Missing src-tauri/build.rs for Tauri build script." && exit 1)

      - name: Configure toolcache paths (self-hosted)
        if: contains(matrix.runs_on, 'self-hosted')
        shell: bash
        run: |
          TOOLCACHE="$HOME/actions-runner/_toolcache"
          mkdir -p "$TOOLCACHE"
          echo "RUNNER_TOOL_CACHE=$TOOLCACHE" >> "$GITHUB_ENV"
          echo "AGENT_TOOLSDIRECTORY=$TOOLCACHE" >> "$GITHUB_ENV"
          echo "RUNNER_TEMP=$HOME/actions-runner/_temp" >> "$GITHUB_ENV"
          echo "TMPDIR=$HOME/actions-runner/_temp" >> "$GITHUB_ENV"
          mkdir -p "$HOME/actions-runner/_temp"

      - name: Install Linux system dependencies
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libjavascriptcoregtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Fix pkg-config search path (setup-python may overwrite PKG_CONFIG_PATH)
        if: startsWith(matrix.os, 'ubuntu')
        shell: bash
        run: |
          DEFAULT_PC_PATH="$(pkg-config --variable pc_path pkg-config)"
          if [[ -n "${PKG_CONFIG_PATH:-}" ]]; then
            echo "PKG_CONFIG_PATH=$DEFAULT_PC_PATH:$PKG_CONFIG_PATH" >> "$GITHUB_ENV"
          else
            echo "PKG_CONFIG_PATH=$DEFAULT_PC_PATH" >> "$GITHUB_ENV"
          fi

      - name: Use local npm cache
        if: contains(matrix.runs_on, 'self-hosted')
        run: echo "npm_config_cache=$HOME/.npm" >> "$GITHUB_ENV"

      - name: Install dependencies
        run: npm ci --workspace services/local-runtime-suite/desktop

      - name: Install local runtime dependencies
        run: pip install -e services/local-runtime-suite/python

      - name: Generate model catalog
        run: python services/local-runtime-suite/tools/gen_models_json.py

      - name: Import macOS signing certificate
        if: startsWith(matrix.os, 'macos')
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPSTORE_CERTIFICATES_FILE_BASE64 }}
          p12-password: ${{ secrets.APPSTORE_CERTIFICATES_PASSWORD }}

      - name: List codesigning identities
        if: startsWith(matrix.os, 'macos')
        run: security find-identity -v -p codesigning

      - name: Build sidecar
        run: npm run sidecar:build -w services/local-runtime-suite/desktop
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ github.token }}
          # keep your mac signing envs here as you already started doing
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        with:
          projectPath: services/local-runtime-suite/desktop
          args: >
            --config src-tauri/tauri.conf.json
            --config src-tauri/tauri.sidecar.conf.json
            --bundles ${{ matrix.bundles }}
          tagName: ${{ inputs.tag || github.ref_name }}
          releaseName: "Local Runtime Suite ${{ inputs.tag || github.ref_name }}"
          releaseBody: "Automated release"
          releaseDraft: false
          prerelease: false
          includeDebug: false
          includeRelease: true
